---
title: "Lange scRNA-seq pseudotime R Notebook"
output:
  github_document: default
  html_document:
    df_print: paged
---



# libraries
```{r}
suppressPackageStartupMessages({
  library(reticulate)
  library(Seurat)
  library(dplyr)
  library(ggplot2)
  library(ggsci)
  library(patchwork)
  library(SeuratDisk)
  library(slingshot)
  library(tradeSeq)
  })
#library(reticulate)
#use_python(python = "/Users/becky/opt/miniconda3/bin/python3", required = TRUE)
options(future.globals.maxSize = 6000 * 1024^2)
```

# read data
zebrafish single cell RNA-seq data downloaded from: https://zebrahub.ds.czbiohub.org/data
```{r}
Lange <- LoadH5Seurat(file = "~/Documents/Projects/Mosimann/Hannah_scRNAseq/data/zf_atlas_full_v4_release.h5seurat", assays = "RNA")
Idents(Lange) <- "zebrafish_anatomy_ontology_class"
DimPlot(Lange, raster = FALSE)
```
integrated scRNA-seq of Lange 16hpf, Lange 24hpf and our scRNA-seq
```{r}
cardio <- readRDS(file = "~/Documents/Projects/Mosimann/Hannah_scRNAseq_Integration_SeuratV5/integrate_and_subset/CardioSubset_v3_Integrated_hand2Bud_Lange16hpf_Lange24hpf.RDS")
```

```{r}
DimPlot(cardio, reduction = "umap.mnn", group.by = "sub.cluster")
```

# name cardio clusters
```{r}
Idents(cardio) <- "sub.cluster"
cardio <- RenameIdents(cardio,
                       "0" = "pericardium",
                       "1" = "pectoral fin",
                       "2" = "floor plate",
                       "3" = "cardiac precursor",
                       "4" = "pharyngeal arch 1",
                       "5" = "pharyngeal arch 2",
                       "6" = "prophenos",
                       "7_0" = "lowExpCells 1",
                       "7_1" = "lowExpCells 2",
                       "7_2" = "lowExpCells 3",
                       "8" = "myocardium",
                       "9" = "highRiboCells")
cardio$named_mnn_clusters <- Idents(cardio)
DimPlot(cardio, reduction = "umap.mnn", group.by = "named_mnn_clusters")
```

# find pericardium cells in Lange dataset
```{r}
tail(WhichCells(cardio))
gsub("Lange_24hpf_","",tail(WhichCells(cardio)))
```

```{r}
Idents(cardio) <- "named_mnn_clusters"
peri_cells <- gsub("Lange_16hpf_","",(gsub("Lange_24hpf_","",WhichCells(cardio, idents = "pericardium"))))
length(peri_cells)
```

```{r}
tail(peri_cells)
head(WhichCells(Lange))
```

```{r, fig.width=5, fig.height=5}
p.umap.full <- DimPlot(Lange, group.by = "zebrafish_anatomy_ontology_class", raster=FALSE)
p.peri.full <- DimPlot(Lange, cells.highlight = peri_cells, raster=FALSE) + NoLegend() + ggtitle("pericardium cells")
p.umap.full
p.peri.full
#ggsave(filename = "results/Lange_full_UMAP.png", plot = p, width = 10, height = 5)
```

```{r}
Idents(Lange) <- "zebrafish_anatomy_ontology_class"
lat_meso <- subset(Lange, idents = "lateral_mesoderm")
```

```{r, fig.width=10, fig.height=5}
lat_meso <- FindVariableFeatures(lat_meso, verbose = F)
lat_meso <- ScaleData(lat_meso, verbose = F)
lat_meso <- RunPCA(lat_meso, verbose = F)
lat_meso <- FindNeighbors(lat_meso, dims = 1:20, verbose = F)
lat_meso <- RunUMAP(lat_meso, dims = 1:20, verbose = F)
lat_meso <- FindClusters(lat_meso, resolution = 1, verbose = F)
DimPlot(lat_meso, group.by = c("timepoint","RNA_snn_res.1"))
```

# cluster IDs of lateral mesoderm subset

Note cardio scRNA-seq contains only Lange 16hpf and Lange 24hpf along with our bud stage data, so only 16hpf and 24hpf Lange cells will be highlighted.

```{r}
pecfin_cells <- gsub("Lange_16hpf_","",(gsub("Lange_24hpf_","",WhichCells(cardio, idents = "pectoral fin"))))
FP_cells <- gsub("Lange_16hpf_","",(gsub("Lange_24hpf_","",WhichCells(cardio, idents = "floor plate"))))
parch1_cells <- gsub("Lange_16hpf_","",(gsub("Lange_24hpf_","",WhichCells(cardio, idents = "pharyngeal arch 1"))))
parch2_cells <- gsub("Lange_16hpf_","",(gsub("Lange_24hpf_","",WhichCells(cardio, idents = "pharyngeal arch 2"))))
cardio_cells <- gsub("Lange_16hpf_","",(gsub("Lange_24hpf_","",WhichCells(cardio, idents = "myocardium"))))
```

```{r, fig.width=10, fig.height=10}
p1 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = peri_cells) + NoLegend() + ggtitle("pericardium cells")
p2 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = pecfin_cells) + NoLegend() + ggtitle("pectoral fin cells")
p3 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = FP_cells) + NoLegend() + ggtitle("floor plate cells")
p4 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = parch1_cells) + NoLegend() + ggtitle("pharyngeal arch 1 cells")
p5 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = parch2_cells) + NoLegend() + ggtitle("pharyngeal arch 2 cells")
p6 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = cardio_cells) + NoLegend() + ggtitle("myocardium cells")
p7 <- DimPlot(lat_meso, group.by = "RNA_snn_res.1", label = T, repel = T) + NoLegend() + ggtitle("Clusters")
p8 <- DimPlot(lat_meso, group.by = "timepoint")
p1 + p2 + p3 + p4 + p5 + p6 + p7 + p8
```

# subset cardiomyocytes, pericardium and precursor clusters

```{r}
p1 <- DimPlot(lat_meso, group.by = "RNA_snn_res.1", label = T) + scale_color_igv()
p2 <- DimPlot(lat_meso, group.by = "RNA_snn_res.1", reduction = 'pca') + scale_color_igv() + NoLegend()
p1 + p2
```

select: 

* 17 – early timepoint cells (10/12hpf) 
* 8 – early timepoint cells (12/14hpf) 
* 15 – pericardium (16/19hpf) 
* 5 – pericardium (24hpf) 
* 19 – cardiomyocytes (16/19/24hpf)

leaving out: 

* 21, 23 – pectoral fin cells 
* 31 – late timepoint cardiomyocytes because don’t have pericarium late timepoint cells

```{r, fig.width=10, fig.height=5}
Idents(lat_meso) <- "RNA_snn_res.1"
lat_meso2 <- subset(lat_meso, idents = c("17","8","15","5","19"))
lat_meso2 <- RenameIdents(lat_meso2,
                          "17" = "Undifferentiated LPM (10/12 hpf)",
                          "8" = "Undifferentiated LPM (12/14 hpf)",
                          "15" = "LPM (16/19 hpf)",
                          "5" = "Pericardium (24 hpf)",
                          "19" = "Myocardium (16/19/24 hpf)")
lat_meso2$subset_clusters <- Idents(lat_meso2)

```

```{r, fig.width=13, fig.height=10}
p1 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = peri_cells) + NoLegend() + ggtitle("pericardium cells")
p2 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = pecfin_cells) + NoLegend() + ggtitle("pectoral fin cells")
p3 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = FP_cells) + NoLegend() + ggtitle("floor plate cells")
p4 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = parch1_cells) + NoLegend() + ggtitle("pharyngeal arch 1 cells")
p5 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = parch2_cells) + NoLegend() + ggtitle("pharyngeal arch 2 cells")
p6 <- DimPlot(lat_meso, reduction = "umap", cells.highlight = cardio_cells) + NoLegend() + ggtitle("myocardium cells")
p.latmeso.cluster <- DimPlot(lat_meso, group.by = "RNA_snn_res.1", label = T, repel = T) + NoLegend() + ggtitle("Clusters")
p.latmeso.time <- DimPlot(lat_meso, group.by = "timepoint")# + theme(legend.position = "bottom")
p.latmeso.sub <- DimPlot(lat_meso2, group.by = "subset_clusters") + ggtitle("Subset Clusters")
p.latmeso.highlight <- p1 + p2 + p3 + p4 + p5 + p6
p.latmeso.highlight
#ggsave(filename = "results/Lange_lat_meso_subset_UMAP.png", plot = p, width = 13, height = 10)
```

```{r, fig.width=5, fig.height=5}
p.latmeso.cluster
p.latmeso.time
p.latmeso.sub
```

```{r, fig.width=5, fig.height=5}
p.pca.time <- DimPlot(lat_meso2, reduction = "pca", group.by = "timepoint")
p.pca.time
#ggsave(filename = "results/Lange_pericardium_subset_pca.png", plot = p, width = 10, height = 5)
```

```{r, fig.width=5, fig.height=5}
p.pca.sub <- DimPlot(lat_meso2, reduction = "pca", group.by = "subset_clusters") + ggtitle("Subset Clusters")
p.pca.sub
#ggsave(filename = "results/Lange_pericardium_subset_pca.png", plot = p, width = 10, height = 5)
```

```{r combined, fig.width=15, fig.height=20}
layout <- "
  AAAABBBB
  CCCCCCCC
  CCCCCCCC
  DDDEEFFF
  GGGGHHHH
  "
#t,l,b,r
# layout <- c(
#   area(1,1,1,3),
#   area(1,4,1,6),
#   area(2,1,3,6),
#   area(4,1,4,3),
#   area(4,3,4,4),
#   area(4,5,4,6),
#   area(5,1,5,3),
#   area(5,4,5,6)
# )
  
  
combined1 <- p.umap.full + p.peri.full + 
  p.latmeso.highlight + 
  p.latmeso.cluster + free(p.latmeso.time) + p.latmeso.sub +
  p.pca.time + p.pca.sub +
  plot_layout(design = layout) + plot_annotation(tag_levels = list(c("A","B","C","","","","","","D","E","F","G","H")))
combined1
ggsave(filename = "results/Supp_Lange_subset.png", width = 15, height = 20, plot = combined1)
```
```{r}
scales::show_col(scales::hue_pal()(5))
show(scales::hue_pal()(5))
```


# slingshot

```{r}
Idents(lat_meso2) <- "subset_clusters"
sce <- as.SingleCellExperiment(lat_meso2, assay = 'RNA')
saveRDS(sce, file = "RDSfiles/Lange_lat_meso2_subset_res1_noPecFin.sce.RDS")
```

```{r}
crv <- slingshot(sce, reducedDim = 'PCA', 
                 clusterLabels = colData(sce)$subset_clusters,
                 start.clus = '10/12hpf cells')
```

```{r}
crv@colData@listData[["slingshot"]]@metadata[["lineages"]][["Lineage1"]]
```

```{r}
crv@colData@listData[["slingshot"]]@metadata[["lineages"]][["Lineage2"]]
```

plotGeneCount puts clusters in alphabetical order in legend (and palette order) despite levels of ident being the order as in Seurat object, so need to set color palette manually to match DimPlot.

"#F8766D" "#A3A500" "#00BF7D" "#00B0F6" "#E76BF3"
"Undifferentiated LPM (10/12 hpf)" "Undifferentiated LPM (12/14 hpf)" "LPM (16/19 hpf)"                  "Pericardium (24 hpf)" "Myocardium (16/19/24 hpf)"
```{r}
p <- plotGeneCount(crv, clusters = colData(sce)$subset_clusters) + 
  scale_color_manual(values = c("#00BF7D","#E76BF3","#00B0F6","#F8766D","#A3A500"))
p
ggsave(filename = "results/Lange_slingshot.png")
```


```{r}
sessionInfo()
```

